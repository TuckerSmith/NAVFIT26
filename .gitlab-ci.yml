stages:
  - build
  - release
  - deploy

variables:
  PACKAGE_NAME: "navfit26"
  # Note: On a branch build, CI_COMMIT_TAG is empty. 
  # This variable is mostly for the formal release stage.
  PACKAGE_REGISTRY_URL: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_NAME}/${CI_COMMIT_TAG}"

build_deb:
  stage: build
  image: node:18
  before_script:
    - apt-get update && apt-get install -y fakeroot dpkg
    # Since your code is in a subfolder, we need to enter it
    - cd NAVFIT26 
  script:
    - npm install
    - npm run package
    # Move the result back up to the root so the next jobs can find it
    - mv out/make/deb/x64/*.deb ../${PACKAGE_NAME}.deb
  artifacts:
    paths:
      - ${PACKAGE_NAME}.deb
    expire_in: 1 day
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "download-page" # Allows testing on your branch

publish_release:
  stage: release
  image: curlimages/curl:latest
  needs:
    - job: build_deb
      artifacts: true
  rules:
    - if: $CI_COMMIT_TAG # Keep this ONLY for tags to avoid registry errors
  script:
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file ${PACKAGE_NAME}.deb \
           "${PACKAGE_REGISTRY_URL}/${PACKAGE_NAME}.deb"
  release:
    tag_name: '$CI_COMMIT_TAG'
    name: 'Release $CI_COMMIT_TAG'
    description: 'Automated release for NAVFIT26 version $CI_COMMIT_TAG'
    assets:
      links:
        - name: 'Download NAVFIT26 (.deb)'
          url: '${PACKAGE_REGISTRY_URL}/${PACKAGE_NAME}.deb'

pages:
  stage: deploy
  image: alpine:latest
  needs:
    - job: build_deb
      artifacts: true
  script:
    - mkdir public
    - cp index.html public/
    - cp ${PACKAGE_NAME}.deb public/
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "download-page"